#!/usr/bin/python


import sys, os, os.path, string, glob, math
import random
import time, datetime
import tempfile
import subprocess
import matplotlib.pyplot as pyplot
import numpy


def usage(a):
    sys.stderr.write("usage: %s [options]\n")
    sys.stderr.write("       [ -in <input-file> ] (def = active condor history)\n")
    sys.stderr.write("       [ -out <output-file> ] (def = stdout)\n")
    sys.stderr.write("       [ -groups ] (plot by accounting groups)\n")
    sys.stderr.write("       [ -submitters ] (plot by full submitter names)\n")
    sys.stderr.write("       [ -cum ] (cumulative plots)\n")
    sys.stderr.write("       [ -ratios ] (plot ratios relative to total values)\n")
    sys.stderr.write("       [ -timeslice <time-res> ] (default = 1 sec)\n")
    sys.exit(1)

argv = sys.argv
argc = len(argv)

fixedArgs = 0
if argc <= fixedArgs: usage(argv[0])

# fixed args

# option defaults
in_fname = None
out_fname = None
by_groups = False
by_submitters = False
cum_plots = False
ratio_plots = False
timeslice = 1

# options
try:
    j = fixedArgs+1
    while j<argc:
        if sys.argv[j]=="-h": usage()
        if sys.argv[j]=="-in":
            j+=1
            if j>=argc: usage(sys.argv[0])
            in_fname = sys.argv[j]
            j+=1
            continue
        if sys.argv[j]=="-out":
            j+=1
            if j>=argc: usage(sys.argv[0])
            out_fname = sys.argv[j]
            j+=1
            continue
        if sys.argv[j]=="-groups":
            by_groups = True
            j+=1
            continue
        if sys.argv[j]=="-submitters":
            by_submitters = True
            j+=1
            continue
        if sys.argv[j]=="-cum":
            cum_plots = True
            j+=1
            continue
        if sys.argv[j]=="-ratios":
            ratio_plots = True
            j+=1
            continue
        if sys.argv[j]=="-timeslice":
            j+=1
            if j>=argc: usage(sys.argv[0])
            timeslice = int(sys.argv[j])
            j+=1
            continue
        usage(argv[0])
except SystemExit:
    raise
except:
    usage(argv[0])


def fill_cum_map(in_file, by_groups=False, by_submitters=False, cum_plots=False, ratio_plots=False, timeslice=1):
    cum_map = {}
    cum_map[""] = []
    first = True
    t0 = 0
    cur_ag = ""
    line_num = 0
    for ln in in_file:
        line_num += 1
        raw_ln = ln
        ln = ln.strip('\r\n')
        t = ln.split()

        if (len(t) < 4): continue

        # job status
        jstat = int(t[2])

        # keep track of most recent accounting group mentioned
        if jstat != 4:
            cur_ag = '*incomplete*'
        elif (by_groups or by_submitters):
            cur_ag = t[3].strip('"')
            if by_groups:
                j = cur_ag.rfind('.')
                if (j>=0): cur_ag = cur_ag[:j]

        # time
        if jstat == 4: tcur = int(t[0])
        else:          tcur = int(t[1])

        # determine zero-time
        if first:
            t0 = tcur
            first = False

        if tcur < t0:
            sys.stderr.write("Warning: skipping out-of-order timestamp line %d of input:\n" % (line_num))
            sys.stderr.write("%s\n" % (raw_ln))
            continue

        # translate time stamps to zero-based from t0
        tcur -= t0
        tcur /= timeslice

        # encountered a new acct grp -- fill in its previous time stamps
        if (by_groups or by_submitters) and (not cum_map.has_key(cur_ag)):
            cum_map[cur_ag] = [[x[0], 0] for x in cum_map[""]]

        for ag in cum_map.keys():
            if ag in ["", cur_ag]: d = 1
            else: d = 0
            if (len(cum_map[ag]) > 0) and (cum_map[ag][-1][0] == tcur):
                cum_map[ag][-1][1] += d
            else:
                cum_map[ag].append([tcur, d])

    # get cum counts
    if cum_plots:
        for ag in cum_map.keys():
            for j in xrange(1, len(cum_map[ag])):
                cum_map[ag][j][1] += cum_map[ag][j-1][1]

    # normalize
    if ratio_plots:
        for j in xrange(0, len(cum_map[""])):
            for ag in cum_map.keys():
                if ag != "": cum_map[ag][j][1] = float(cum_map[ag][j][1]) / float(cum_map[""][j][1])

    if not (by_groups or by_submitters):
        cum_map["*total*"] = cum_map[""]
    del cum_map[""]

    return cum_map


if out_fname == None: out_file = sys.stdout
else: out_file = open(out_fname, "w")

# temp file for condor_history output
ho_fname = tempfile.mktemp(prefix="ppt_")
ho_file = open(ho_fname, "w")

# construct condor_history command
chc = ['condor_history']
if in_fname != None: chc.extend(['-f', in_fname])
chc.extend(['-format', '%s', 'CompletionDate'])
chc.extend(['-format', ' %s', 'EnteredCurrentStatus'])
chc.extend(['-format', ' %s', 'JobStatus'])
chc.extend(['-format', ' %s\n', 'ifThenElse(AccountingGroup=!=UNDEFINED, AccountingGroup, "*none*"'])

# invoke condor_history to generate our desired output
subprocess.call(chc, stdout=ho_file)
ho_file.close()

# read the output of condor_history command and generate map of cumulative acct grp ratios
ho_file = open(ho_fname, "r")
cum_map = fill_cum_map(ho_file, by_groups=by_groups, by_submitters=by_submitters, cum_plots=cum_plots, ratio_plots=ratio_plots, timeslice=timeslice)

keys = cum_map.keys()
keys.sort()

xlab = "Time (sec)"
ylab = "thruput"
title = "thruput"
if cum_plots:
    ylab = "Cumulative " + ylab
    title = "Cumulative " + title
if ratio_plots:
    ylab = ylab + " ratios"
    title = title + " ratios"
title = title + " vs Time"

fig = pyplot.figure()
ax = fig.add_subplot(111)
for k in keys:
    plt = ax.plot([x[0] for x in cum_map[k]], [x[1] for x in cum_map[k]])
ax.set_xlabel(xlab)
ax.set_ylabel(ylab)
ax.set_title(title)
ax.legend(keys)
pyplot.show()
